<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3b82f6">
    <meta name="description" content="Professional GPS-enabled land mapping tool for accurate boundary tracking on mobile devices">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHBhdGggZD0iTTc2IDQ0SDUyVjg0SDc2Wk00NCA2OEwyNyA4MUwzMiA4NUw0NCA2OE02NCA0NEM2NCAzMC4zIDQ5LjYgMjAgMzcgMjRIMzdDMjguNCAyOSAjMjIgMi4yIDIyIDVDMjIgMTAuMyAyOC4zIDE2IDM3IDE2IDQ4LjA1IDE2IDUzMSAxNiA1MSAyMSA3My43IDI2IDEwMCAyNSBDMTI3IDI5LjMgMTI3KDI0IDM2Yy0xLTIgMC42LTMgMS44LTQgMi45LTQuMi40LTQgOC40LTcgMTMuMyAxMmMxNC4zIDAgMjYuNiAxMi42IDIyIDUgMjNONjcgMTA2UzcyLjUgOTMgNTYgOTFMMjQgNzhDNy4xIDc0IDAgNjQuMyAwIDU0VjIyQzAgOS43IDcuMSA0NCA0NCA0NEg0MCUxODkgNzNDNjUgNTguOCA2NCA0OC44IDY0IDQ0VjIyWiIgc3Ryb2tlPSIjMzI5OUYiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0iIzMyOTlGIi8+Cjwvc3ZnPg==">
    <title>Land Mapping GPS Tracker - Mobile Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; width: 100%; touch-action: pan-x pan-y; }
        .leaflet-control-container .leaflet-top { z-index: 400; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.7); }
        
        * { 
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }
        .pulse-animate { animation: pulse-ring 2s ease-in-out infinite; }

        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        .ripple-effect::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: currentColor;
            opacity: 0;
            animation: ripple 0.6s ease-out;
        }

        .dark body { background-color: #0f172a; }
        .dark #map { filter: brightness(0.9); }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 500;
            transition: transform 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        .control-panel.minimized {
            transform: translateY(calc(100% - 60px));
        }

        .drag-handle {
            width: 48px;
            height: 4px;
            background: rgba(156, 163, 175, 0.5);
            border-radius: 2px;
            margin: 0 auto 12px;
            cursor: grab;
        }

        .btn-large {
            min-height: 56px;
            font-size: 1.125rem;
        }

        @media (max-width: 640px) {
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-slate-900">
    
    <!-- Theme Toggle & Menu -->
    <div class="absolute top-4 right-4 z-[600] flex gap-2">
        <button id="menuToggle" class="p-3 rounded-full glass bg-white/80 dark:bg-gray-800/80 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        <button id="themeToggle" class="p-3 rounded-full glass bg-white/80 dark:bg-gray-800/80 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
            <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg id="moonIcon" class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
    </div>

    <!-- GPS Accuracy Indicator -->
    <div id="accuracyBadge" class="absolute top-4 left-4 z-[600] glass bg-white/90 dark:bg-gray-800/90 rounded-xl shadow-lg px-4 py-2 hidden">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full pulse-animate" id="accuracyDot"></div>
            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300" id="accuracyText">--</span>
        </div>
    </div>

    <!-- Main Control Panel (Bottom Sheet) -->
    <div id="controlPanel" class="control-panel">
        <div class="glass bg-white/95 dark:bg-gray-800/95 rounded-t-3xl shadow-2xl p-5 border-t border-white/20 dark:border-gray-700/50">
            
            <div class="drag-handle"></div>
            
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400 bg-clip-text text-transparent">
                            Land Mapper Pro
                        </h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Mobile Edition</p>
                    </div>
                </div>
                <button id="togglePanel" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg id="panelUpIcon" class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>
            
            <div class="flex gap-2 mb-4 p-1 bg-gray-100 dark:bg-gray-700/50 rounded-xl">
                <button id="gpsMode" class="flex-1 py-3 px-4 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg transform transition-all duration-200 active:scale-95 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    GPS Walk
                </button>
                <button id="tapMode" class="flex-1 py-3 px-4 rounded-lg bg-transparent text-gray-700 dark:text-gray-300 font-semibold transition-all duration-200 active:scale-95 hover:bg-white/50 dark:hover:bg-gray-600/50 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                    </svg>
                    Tap Points
                </button>
            </div>

            <!-- GPS Controls -->
            <div id="gpsControls" class="space-y-3">
                <div class="flex gap-2">
                    <button id="startGPS" class="flex-1 btn-large py-4 px-4 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold shadow-lg hover:shadow-xl transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Start GPS Tracking
                    </button>
                    <button id="autoFollowToggle" class="p-4 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 shadow-md transition-all duration-200 active:scale-95" title="Auto-follow GPS">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                </div>
                <button id="stopGPS" class="w-full btn-large py-4 px-4 rounded-xl bg-gradient-to-r from-red-500 to-rose-600 text-white font-semibold shadow-lg hover:shadow-xl transform active:scale-95 transition-all duration-200 hidden flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                    Stop Tracking
                </button>
                <div id="gpsStatus" class="glass bg-green-50/80 dark:bg-green-900/20 border border-green-200 dark:border-green-800 p-3 rounded-xl hidden">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full pulse-animate"></div>
                        <span class="text-sm font-medium text-green-700 dark:text-green-300">GPS Tracking Active</span>
                    </div>
                </div>
            </div>

            <!-- Tap Controls -->
            <div id="tapControls" class="space-y-3 hidden">
                <div class="glass bg-blue-50/80 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 p-4 rounded-xl">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-1">Tap to Add Points</p>
                            <p class="text-xs text-blue-700 dark:text-blue-300">Touch anywhere on the map to mark boundary points</p>
                        </div>
                    </div>
                </div>
                <button id="undoPoint" class="w-full btn-large py-4 px-4 rounded-xl bg-gradient-to-r from-yellow-500 to-amber-600 text-white font-semibold shadow-lg hover:shadow-xl transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    </svg>
                    Undo Last Point
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4 space-y-2">
                <div class="grid grid-cols-2 gap-2">
                    <button id="clearMap" class="btn-large py-3 px-4 rounded-xl bg-gray-600 dark:bg-gray-700 text-white font-semibold hover:bg-gray-700 dark:hover:bg-gray-600 shadow-md hover:shadow-lg transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Clear
                    </button>
                    <button id="completePolygon" class="btn-large py-3 px-4 rounded-xl bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold shadow-md hover:shadow-lg transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Complete
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="calculateArea" class="btn-large py-3 px-4 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold shadow-md hover:shadow-lg transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Area
                    </button>
                    <button id="saveBoundary" class="btn-large py-3 px-4 rounded-xl bg-gradient-to-r from-teal-500 to-cyan-600 text-white font-semibold shadow-md hover:shadow-lg transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="mt-4 grid grid-cols-3 gap-2">
                <div class="glass bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-3 rounded-xl border border-blue-200/50 dark:border-blue-800/50">
                    <div class="flex flex-col items-center">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        </svg>
                        <span class="text-xs text-gray-600 dark:text-gray-400 mb-0.5">Points</span>
                        <span id="pointCount" class="text-lg font-bold text-gray-800 dark:text-white">0</span>
                    </div>
                </div>
                <div class="glass bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-3 rounded-xl border border-green-200/50 dark:border-green-800/50">
                    <div class="flex flex-col items-center">
                        <svg class="w-5 h-5 text-green-600 dark:text-green-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                        </svg>
                        <span class="text-xs text-gray-600 dark:text-gray-400 mb-0.5">Area</span>
                        <span id="areaDisplay" class="text-xs font-bold text-gray-800 dark:text-white">-- m²</span>
                    </div>
                </div>
                <div class="glass bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-3 rounded-xl border border-purple-200/50 dark:border-purple-800/50">
                    <div class="flex flex-col items-center">
                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        <span class="text-xs text-gray-600 dark:text-gray-400 mb-0.5">Distance</span>
                        <span id="distanceDisplay" class="text-xs font-bold text-gray-800 dark:text-white">-- m</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // Mobile-specific utilities
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let wakeLock = null;

        // Vibration feedback
        function vibrate(pattern = 50) {
            if ('vibrate' in navigator && isMobile) {
                navigator.vibrate(pattern);
            }
        }

        // Screen wake lock for GPS tracking
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake lock acquired');
                }
            } catch (err) {
                console.log('Wake lock failed:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake lock released');
            }
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('Service Worker registered successfully:', reg);
                    })
                    .catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }

        // Theme Management
        const html = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            html.classList.add('dark');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        }

        themeToggle.addEventListener('click', () => {
            vibrate(30);
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            if (isDark) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        });

        // Panel toggle functionality
        const controlPanel = document.getElementById('controlPanel');
        const togglePanelBtn = document.getElementById('togglePanel');
        const panelUpIcon = document.getElementById('panelUpIcon');
        let isPanelMinimized = false;

        togglePanelBtn.addEventListener('click', () => {
            vibrate(30);
            isPanelMinimized = !isPanelMinimized;
            controlPanel.classList.toggle('minimized', isPanelMinimized);
            panelUpIcon.style.transform = isPanelMinimized ? 'rotate(180deg)' : 'rotate(0)';
        });

        // Drag to minimize panel
        let touchStartY = 0;
        let touchEndY = 0;
        const dragHandle = document.querySelector('.drag-handle');

        dragHandle.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        dragHandle.addEventListener('touchmove', (e) => {
            touchEndY = e.touches[0].clientY;
            const diff = touchEndY - touchStartY;
            if (diff > 50 && !isPanelMinimized) {
                isPanelMinimized = true;
                controlPanel.classList.add('minimized');
                panelUpIcon.style.transform = 'rotate(180deg)';
                vibrate(30);
            } else if (diff < -50 && isPanelMinimized) {
                isPanelMinimized = false;
                controlPanel.classList.remove('minimized');
                panelUpIcon.style.transform = 'rotate(0)';
                vibrate(30);
            }
        }, { passive: true });

        // Initialize map
        const map = L.map('map', {
            tap: true,
            tapTolerance: 15
        }).setView([7.8731, 80.7718], 13);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri',
            maxZoom: 20
        }).addTo(map);

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 20
        }).addTo(map);

        // State management
        let currentMode = 'gps';
        let isTracking = false;
        let autoFollow = true;
        let watchId = null;
        let boundaryPoints = [];
        let markers = [];
        let polyline = null;
        let polygon = null;
        let currentLocationMarker = null;
        let totalDistance = 0;

        // UI Elements
        const gpsModeBtn = document.getElementById('gpsMode');
        const tapModeBtn = document.getElementById('tapMode');
        const gpsControls = document.getElementById('gpsControls');
        const tapControls = document.getElementById('tapControls');
        const startGPSBtn = document.getElementById('startGPS');
        const stopGPSBtn = document.getElementById('stopGPS');
        const autoFollowToggle = document.getElementById('autoFollowToggle');
        const gpsStatus = document.getElementById('gpsStatus');
        const undoPointBtn = document.getElementById('undoPoint');
        const clearMapBtn = document.getElementById('clearMap');
        const completePolygonBtn = document.getElementById('completePolygon');
        const calculateAreaBtn = document.getElementById('calculateArea');
        const saveBoundaryBtn = document.getElementById('saveBoundary');
        const pointCountEl = document.getElementById('pointCount');
        const areaDisplayEl = document.getElementById('areaDisplay');
        const distanceDisplayEl = document.getElementById('distanceDisplay');
        const accuracyBadge = document.getElementById('accuracyBadge');
        const accuracyText = document.getElementById('accuracyText');
        const accuracyDot = document.getElementById('accuracyDot');

        // Notification system
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification glass ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 
                'bg-blue-500'
            } text-white`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            vibrate(type === 'error' ? [50, 50, 50] : 50);
            setTimeout(() => notification.remove(), duration);
        }

        // Auto-follow toggle
        autoFollowToggle.addEventListener('click', () => {
            autoFollow = !autoFollow;
            vibrate(30);
            if (autoFollow) {
                autoFollowToggle.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                autoFollowToggle.classList.add('bg-blue-500', 'text-white');
                showNotification('Auto-follow enabled', 'success');
            } else {
                autoFollowToggle.classList.remove('bg-blue-500', 'text-white');
                autoFollowToggle.classList.add('bg-gray-200', 'dark:bg-gray-700');
                showNotification('Auto-follow disabled', 'info');
            }
        });

        // Set initial auto-follow state
        autoFollowToggle.classList.add('bg-blue-500', 'text-white');

        // Mode switching
        gpsModeBtn.addEventListener('click', () => {
            vibrate(30);
            currentMode = 'gps';
            gpsModeBtn.classList.remove('bg-transparent', 'text-gray-700', 'dark:text-gray-300');
            gpsModeBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg');
            tapModeBtn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg');
            tapModeBtn.classList.add('bg-transparent', 'text-gray-700', 'dark:text-gray-300');
            gpsControls.classList.remove('hidden');
            tapControls.classList.add('hidden');
            map.off('click');
        });

        tapModeBtn.addEventListener('click', () => {
            vibrate(30);
            currentMode = 'tap';
            tapModeBtn.classList.remove('bg-transparent', 'text-gray-700', 'dark:text-gray-300');
            tapModeBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg');
            gpsModeBtn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg');
            gpsModeBtn.classList.add('bg-transparent', 'text-gray-700', 'dark:text-gray-300');
            tapControls.classList.remove('hidden');
            gpsControls.classList.add('hidden');
            
            if (isTracking) {
                stopGPSTracking();
            }
            
            enableTapMode();
        });

        // GPS Tracking
        startGPSBtn.addEventListener('click', startGPSTracking);
        stopGPSBtn.addEventListener('click', stopGPSTracking);

        function startGPSTracking() {
            if (!navigator.geolocation) {
                showNotification('Geolocation is not supported by your device', 'error');
                return;
            }

            vibrate([50, 100, 50]);
            isTracking = true;
            startGPSBtn.classList.add('hidden');
            stopGPSBtn.classList.remove('hidden');
            stopGPSBtn.style.display = 'flex';
            gpsStatus.classList.remove('hidden');
            accuracyBadge.classList.remove('hidden');
            
            requestWakeLock();

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    } else {
                        currentLocationMarker = L.circleMarker([lat, lng], {
                            radius: 10,
                            fillColor: '#3b82f6',
                            color: '#fff',
                            weight: 4,
                            fillOpacity: 1
                        }).addTo(map);
                    }

                    // Filter by accuracy (only add points with good accuracy)
                    if (accuracy <= 30) {
                        addBoundaryPoint(lat, lng);
                        accuracyDot.style.backgroundColor = '#10b981';
                    } else if (accuracy <= 50) {
                        accuracyDot.style.backgroundColor = '#f59e0b';
                    } else {
                        accuracyDot.style.backgroundColor = '#ef4444';
                    }

                    accuracyText.textContent = `±${Math.round(accuracy)}m`;
                    
                    if (autoFollow) {
                        map.setView([lat, lng], Math.max(map.getZoom(), 18), {
                            animate: true,
                            duration: 0.5
                        });
                    }
                },
                (error) => {
                    console.error('GPS Error:', error);
                    showNotification('GPS error: ' + error.message, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function stopGPSTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            vibrate([50, 100, 50]);
            isTracking = false;
            startGPSBtn.classList.remove('hidden');
            stopGPSBtn.classList.add('hidden');
            gpsStatus.classList.add('hidden');
            accuracyBadge.classList.add('hidden');
            
            releaseWakeLock();
        }

        // Tap Mode
        function enableTapMode() {
            map.on('click', (e) => {
                if (currentMode === 'tap') {
                    addBoundaryPoint(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lng2 - lng1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Add boundary point
        function addBoundaryPoint(lat, lng) {
            // Calculate distance from previous point
            if (boundaryPoints.length > 0) {
                const prev = boundaryPoints[boundaryPoints.length - 1];
                const dist = calculateDistance(prev[0], prev[1], lat, lng);
                totalDistance += dist;
            }

            boundaryPoints.push([lat, lng]);
            vibrate(50);

            const marker = L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: '#ef4444',
                color: '#fff',
                weight: 3,
                fillOpacity: 1,
                className: 'pulse-animate'
            }).addTo(map);
            
            marker.bindPopup(`
                <div class="text-center p-2">
                    <strong class="text-blue-600">Point ${boundaryPoints.length}</strong><br>
                    <span class="text-xs text-gray-600">Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}</span>
                </div>
            `);
            markers.push(marker);

            if (polyline) {
                map.removeLayer(polyline);
            }
            polyline = L.polyline(boundaryPoints, {
                color: '#3b82f6',
                weight: 4,
                opacity: 0.8
            }).addTo(map);

            updateStats();
        }

        // Undo last point
        undoPointBtn.addEventListener('click', () => {
            if (boundaryPoints.length > 0) {
                vibrate([50, 30, 50]);
                
                // Recalculate total distance
                if (boundaryPoints.length >= 2) {
                    const lastTwo = boundaryPoints.slice(-2);
                    const dist = calculateDistance(lastTwo[0][0], lastTwo[0][1], lastTwo[1][0], lastTwo[1][1]);
                    totalDistance -= dist;
                }
                
                boundaryPoints.pop();
                const lastMarker = markers.pop();
                if (lastMarker) {
                    map.removeLayer(lastMarker);
                }
                
                if (polyline) {
                    map.removeLayer(polyline);
                }
                
                if (boundaryPoints.length > 0) {
                    polyline = L.polyline(boundaryPoints, {
                        color: '#3b82f6',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);
                }
                
                updateStats();
                showNotification('Last point removed', 'success');
            }
        });

        // Clear map
        clearMapBtn.addEventListener('click', () => {
            if (boundaryPoints.length === 0) {
                showNotification('Map is already empty', 'info');
                return;
            }
            
            if (confirm('Are you sure you want to clear all points?')) {
                vibrate([50, 50, 50]);
                boundaryPoints = [];
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                totalDistance = 0;
                
                if (polyline) {
                    map.removeLayer(polyline);
                    polyline = null;
                }
                if (polygon) {
                    map.removeLayer(polygon);
                    polygon = null;
                }
                
                updateStats();
                showNotification('Map cleared', 'success');
            }
        });

        // Complete polygon
        completePolygonBtn.addEventListener('click', () => {
            if (boundaryPoints.length < 3) {
                showNotification('Need at least 3 points to complete polygon', 'error');
                return;
            }

            vibrate([50, 100, 50]);
            
            if (polygon) {
                map.removeLayer(polygon);
            }

            polygon = L.polygon(boundaryPoints, {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.3,
                weight: 3
            }).addTo(map);

            map.fitBounds(polygon.getBounds(), { padding: [50, 50] });
            showNotification('Polygon completed!', 'success');
        });

        // Calculate area
        calculateAreaBtn.addEventListener('click', () => {
            if (boundaryPoints.length < 3) {
                showNotification('Need at least 3 points to calculate area', 'error');
                return;
            }

            vibrate([50, 100, 50]);
            const area = calculatePolygonArea(boundaryPoints);
            areaDisplayEl.textContent = `${area.toFixed(2)} m²`;
            
            const acres = (area * 0.000247105).toFixed(4);
            const hectares = (area * 0.0001).toFixed(4);
            
            showNotification(`Area: ${area.toFixed(2)} m² | ${acres} acres | ${hectares} ha`, 'success', 5000);
        });

        // Save boundary
        saveBoundaryBtn.addEventListener('click', () => {
            if (boundaryPoints.length < 3) {
                showNotification('Need at least 3 points to save', 'error');
                return;
            }

            vibrate([50, 100, 50]);
            const area = calculatePolygonArea(boundaryPoints);
            const boundary = {
                points: boundaryPoints,
                area: area,
                distance: totalDistance,
                timestamp: new Date().toISOString(),
                name: `Boundary ${new Date().toLocaleString()}`
            };

            const savedBoundaries = JSON.parse(localStorage.getItem('savedBoundaries') || '[]');
            savedBoundaries.push(boundary);
            localStorage.setItem('savedBoundaries', JSON.stringify(savedBoundaries));

            showNotification('Boundary saved successfully!', 'success');
        });

        // Calculate polygon area using Shoelace formula
        function calculatePolygonArea(points) {
            if (points.length < 3) return 0;

            const R = 6371000; // Earth's radius in meters
            let area = 0;

            for (let i = 0; i < points.length; i++) {
                const p1 = points[i];
                const p2 = points[(i + 1) % points.length];
                
                const lat1 = p1[0] * Math.PI / 180;
                const lat2 = p2[0] * Math.PI / 180;
                const lng1 = p1[1] * Math.PI / 180;
                const lng2 = p2[1] * Math.PI / 180;
                
                area += (lng2 - lng1) * (2 + Math.sin(lat1) + Math.sin(lat2));
            }

            area = Math.abs(area * R * R / 2);
            return area;
        }

        // Update stats
        function updateStats() {
            pointCountEl.textContent = boundaryPoints.length;
            
            if (boundaryPoints.length >= 3) {
                const area = calculatePolygonArea(boundaryPoints);
                areaDisplayEl.textContent = `${area.toFixed(2)} m²`;
            } else {
                areaDisplayEl.textContent = '-- m²';
            }

            if (totalDistance > 1000) {
                distanceDisplayEl.textContent = `${(totalDistance / 1000).toFixed(2)} km`;
            } else {
                distanceDisplayEl.textContent = `${Math.round(totalDistance)} m`;
            }
        }

        // Request user location on load
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    showNotification('Location found', 'success');
                },
                (error) => {
                    console.log('Location error:', error);
                }
            );
        }

        // Add recenter button
        const recenterBtn = L.control({ position: 'bottomright' });
        recenterBtn.onAdd = function() {
            const btn = L.DomUtil.create('button', 'glass bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-3 rounded-full shadow-lg hover:shadow-xl transform active:scale-95 transition-all duration-200 mb-2');
            btn.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            `;
            btn.title = 'Center on my location';
            btn.onclick = function(e) {
                e.stopPropagation();
                vibrate(30);
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            map.setView([position.coords.latitude, position.coords.longitude], 18);
                            showNotification('Centered on your location', 'success');
                        }
                    );
                }
            };
            return btn;
        };
        recenterBtn.addTo(map);
    </script>
</body>
</html>
