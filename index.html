<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <meta name="description" content="GPS-enabled land mapping tool for boundary tracking">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkxhbmQgTWFwcGVyIiwKICAic2hvcnRfbmFtZSI6ICJMYW5kTWFwIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZjE3MmEiLAogICJ0aGVtZV9jb2xvciI6ICIjM2I4MmY2IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lnZG1sbGQwSnZlRDBpTUNBd0lERXlPQ0F4TWpnaUlHWnBiR3c5SW01dmJtVWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStDaUFnUEhCaGRHZ2daRDBpVFRjMklEUTBTRFV5VmpnMFNEYzJXazFOTkRRZ05qaE1NamNnT0RGTU16SWdPRFZNTkRRZ05qaE5OalFnTkRSRE5qUWdNekF1TXlBME9TNDJJREk3SURNM0lESTBTRE0zUXpJNExqUWdNamtnSXpJeUlESXVJREl5SURVZ1F6SXlJREV3TGpNZ01qZ3VNeUF4TmlBek55QXhOaUEwT0M0d05TQXhOaUExTXpFZ01UWWdOVEVnTWpFZ056TXVOeUF5TmlBeE1EQWdNalVnUXpFeU55QXlPUzR6SURFeU55Z3lOQ0F6Tm1NeExUSWdNQzQyTFRNZ01TNDRMVFFnTWk0NUxUUXVNaTQwTFRRZ09DNDBMVGNnTVRNdU15QXhNbU14TkM0eklEQWdNall1TmlBeE1pNDJJREl5SURVZ01qTk9OamNnTVRBMlV6Y3lMalVnT1RNZ05UWWdPVEZNTWpRZ056aEROeTR4SURjMElEQWdOalF1TXlBd0lEVTBWakl5UXpBZ09TNDNJRGN1TVNBME5DQTBOQ0EwTkVnME1DVXhPRGtnTnpORE5qVWdOVGd1T0NBMk5DQTBPQzQ0SURZMElEUTBWakl5V2lJZ2MzUnliMnRsUFNJak16STVPVVlpSUhOMGNtOXJaUzEzYVdSMGFEMGlNaUlnWm1sc2JEMGlJek15T1RsR0lpOCtDand2YzNablBnPT0iLAogICAgICAic2l6ZXMiOiAiMTI4eDEyOCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJRFV4TWlBMU1USWlJR1pwYkd3OUltNXZibVVpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrQ2lBZ1BIQmhkR2dnWkQwaVRUSTBOQ0F4TnpaTk1USTRJREl6TmxneE1UWWdNelE0U0RFeU9GWXlNek5OTkRBd0lERTNOa015TXpZdU5TQXhOell0TVRZd0lERXdPUzQxTFRFMk1DQTBPRll6TmpoRE1qUXdJRFF3TXk0MUlESXpOaTQxSURNek5pQXlORFFnTXpNMlNETXhNbFl4TnpaRE1UVXlJREUzTmlBeE1qZ2dNVGMySURFeU9DQXlNelpOTWpVMklERTNOa013T1RZZ01UYzJJRFFnTWpNMUxqVWdOQ0F6TVRaV016ZzRRekVnTkRBekxqVWdNakk0SURRd01pNDFJREkxTmlBME1EQmFUVEUzTmlBeE1qVk1NVEUwSURNeU1rZ3hOallnTlRZNU1rd3hOellnTVRJMVdpSWdjM1J5YjJ0bFBTSWpNekk1T1VZaUlITjBjbTlyWlMxM2FXUjBhRDBpTXlJZ1ptbHNiRDBpSXpNeU9UbEdJaTgrQ2p3dmMzWm5QZz09IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHBhdGggZD0iTTc2IDQ0SDUyVjg0SDc2Wk00NCA2OEwyNyA4MUwzMiA4NUw0NCA2OE02NCA0NEM2NCAzMC4zIDQ5LjYgMjAgMzcgMjRIMzdDMjguNCAyOSAjMjIgMi4yIDIyIDVDMjIgMTAuMyAyOC4zIDE2IDM3IDE2IDQ4LjA1IDE2IDUzMSAxNiA1MSAyMSA3My43IDI2IDEwMCAyNSBDMTI3IDI5LjMgMTI3KDI0IDM2Yy0xLTIgMC42LTMgMS44LTQgMi45LTQuMi40LTQgOC40LTcgMTMuMyAxMmMxNC4zIDAgMjYuNiAxMi42IDIyIDUgMjNONjcgMTA2UzcyLjUgOTMgNTYgOTFMMjQgNzhDNy4xIDc0IDAgNjQuMyAwIDU0VjIyQzAgOS43IDcuMSA0NCA0NCA0NEg0MCUxODkgNzNDNjUgNTguOCA2NCA0OC44IDY0IDQ0VjIyWiIgc3Ryb2tlPSIjMzI5OUYiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0iIzMyOTlGIi8+Cjwvc3ZnPg==">
    <title>Land Mapping GPS Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; width: 100%; }
        .leaflet-control-container .leaflet-top { z-index: 400; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.7); }
        
        * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        
        .glass {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }
        .pulse-animate { animation: pulse-ring 2s ease-in-out infinite; }

        .dark body { background-color: #0f172a; }
        .dark #map { filter: brightness(0.9); }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .install-prompt {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            max-width: 90%;
            width: 400px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-slate-900">
    
    <!-- PWA Install Prompt -->
    <div id="installPrompt" class="install-prompt hidden">
        <div class="glass bg-white/95 dark:bg-gray-800/95 rounded-2xl shadow-2xl p-4 border border-white/20 dark:border-gray-700/50">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center flex-shrink-0">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-gray-900 dark:text-white">Install Land Mapper</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Use offline & access quickly</p>
                </div>
                <button id="installBtn" class="px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold text-sm hover:bg-blue-600 transition-colors">
                    Install
                </button>
                <button id="dismissInstall" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Theme Toggle -->
    <div class="absolute top-4 right-4 z-[600]">
        <button id="themeToggle" class="p-3 rounded-full glass bg-white/80 dark:bg-gray-800/80 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
            <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg id="moonIcon" class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
    </div>

    <!-- Main Control Panel -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[500] w-11/12 max-w-md">
        <div class="glass bg-white/90 dark:bg-gray-800/90 rounded-2xl shadow-2xl p-5 border border-white/20 dark:border-gray-700/50">
            
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400 bg-clip-text text-transparent">
                        Land Mapper
                    </h1>
                </div>
                <div id="connectionStatus" class="flex items-center gap-1.5 text-xs">
                    <div class="w-2 h-2 bg-green-500 rounded-full pulse-animate"></div>
                    <span class="text-gray-600 dark:text-gray-400 font-medium">Ready</span>
                </div>
            </div>
            
            <div class="flex gap-2 mb-4 p-1 bg-gray-100 dark:bg-gray-700/50 rounded-xl">
                <button id="gpsMode" class="flex-1 py-2.5 px-4 rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg transform transition-all duration-200 hover:scale-105 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    GPS Walk
                </button>
                <button id="tapMode" class="flex-1 py-2.5 px-4 rounded-lg bg-transparent text-gray-700 dark:text-gray-300 font-semibold transition-all duration-200 hover:bg-white/50 dark:hover:bg-gray-600/50 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                    </svg>
                    Tap Points
                </button>
            </div>

            <div id="gpsControls" class="space-y-3">
                <button id="startGPS" class="w-full py-3.5 px-4 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Start GPS Tracking
                </button>
                <button id="stopGPS" class="w-full py-3.5 px-4 rounded-xl bg-gradient-to-r from-red-500 to-rose-600 text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 hidden flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                    Stop Tracking
                </button>
                <div id="gpsStatus" class="glass bg-green-50/80 dark:bg-green-900/20 border border-green-200 dark:border-green-800 p-3 rounded-xl hidden">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full pulse-animate"></div>
                        <span class="text-sm font-medium text-green-700 dark:text-green-300">GPS Tracking Active</span>
                    </div>
                </div>
            </div>

            <div id="tapControls" class="space-y-3 hidden">
                <div class="glass bg-blue-50/80 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 p-4 rounded-xl">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-1">Tap to Add Points</p>
                            <p class="text-xs text-blue-700 dark:text-blue-300">Touch anywhere on the map to mark boundary points</p>
                        </div>
                    </div>
                </div>
                <button id="undoPoint" class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-yellow-500 to-amber-600 text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    </svg>
                    Undo Last Point
                </button>
            </div>

            <div class="mt-4 space-y-2">
                <div class="grid grid-cols-2 gap-2">
                    <button id="clearMap" class="py-2.5 px-4 rounded-xl bg-gray-600 dark:bg-gray-700 text-white font-semibold hover:bg-gray-700 dark:hover:bg-gray-600 shadow-md hover:shadow-lg transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Clear
                    </button>
                    <button id="completePolygon" class="py-2.5 px-4 rounded-xl bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold shadow-md hover:shadow-lg transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Complete
                    </button>
                </div>
                <button id="calculateArea" class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold shadow-md hover:shadow-lg transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    Calculate Area
                </button>
            </div>

            <div class="mt-4 grid grid-cols-3 gap-2">
                <div class="glass bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-3 rounded-xl border border-blue-200/50 dark:border-blue-800/50">
                    <div class="flex flex-col items-center">
                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        </svg>
                        <span class="text-xs text-gray-600 dark:text-gray-400 mb-0.5">Points</span>
                        <span id="pointCount" class="text-lg font-bold text-gray-800 dark:text-white">0</span>
                    </div>
                </div>
                <div class="glass bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-3 rounded-xl border border-green-200/50 dark:border-green-800/50">
                    <div class="flex flex-col items-center">
                        <svg class="w-5 h-5 text-green-600 dark:text-green-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                        </svg>
                        <span class="text-xs text-gray-600 dark:text-gray-400 mb-0.5">Area</span>
                        <span id="areaDisplay" class="text-xs font-bold text-gray-800 dark:text-white">-- m²</span>
                    </div>
                </div>
                <div class="glass bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-3 rounded-xl border border-purple-200/50 dark:border-purple-800/50">
                    <div class="flex flex-col items-center">
                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                        </svg>
                        <span class="text-xs text-gray-600 dark:text-gray-400 mb-0.5">GPS</span>
                        <span id="accuracyDisplay" class="text-xs font-bold text-gray-800 dark:text-white">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Create service worker inline
                const swCode = `
                    const CACHE_NAME = 'land-mapper-v1';
                    const urlsToCache = [
                        '/',
                        'https://cdn.tailwindcss.com',
                        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
                        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });

                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const dismissInstall = document.getElementById('dismissInstall');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.remove('hidden');
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installPrompt.classList.add('hidden');
            }
        });

        dismissInstall.addEventListener('click', () => {
            installPrompt.classList.add('hidden');
            deferredPrompt = null;
        });

        // Theme Management
        const html = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            html.classList.add('dark');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            if (isDark) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        });

        // Initialize map
        const map = L.map('map').setView([7.8731, 80.7718], 13);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri',
            maxZoom: 19
        }).addTo(map);

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }).addTo(map);

        // State management
        let currentMode = 'gps';
        let isTracking = false;
        let watchId = null;
        let boundaryPoints = [];
        let markers = [];
        let polyline = null;
        let polygon = null;
        let currentLocationMarker = null;

        // UI Elements
        const gpsModeBtn = document.getElementById('gpsMode');
        const tapModeBtn = document.getElementById('tapMode');
        const gpsControls = document.getElementById('gpsControls');
        const tapControls = document.getElementById('tapControls');
        const startGPSBtn = document.getElementById('startGPS');
        const stopGPSBtn = document.getElementById('stopGPS');
        const gpsStatus = document.getElementById('gpsStatus');
        const undoPointBtn = document.getElementById('undoPoint');
        const clearMapBtn = document.getElementById('clearMap');
        const completePolygonBtn = document.getElementById('completePolygon');
        const calculateAreaBtn = document.getElementById('calculateArea');
        const pointCountEl = document.getElementById('pointCount');
        const areaDisplayEl = document.getElementById('areaDisplay');
        const accuracyDisplayEl = document.getElementById('accuracyDisplay');

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification glass ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 
                'bg-blue-500'
            } text-white`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Mode switching
        gpsModeBtn.addEventListener('click', () => {
            currentMode = 'gps';
            gpsModeBtn.classList.remove('bg-transparent', 'text-gray-700', 'dark:text-gray-300');
            gpsModeBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg');
            tapModeBtn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg');
            tapModeBtn.classList.add('bg-transparent', 'text-gray-700', 'dark:text-gray-300');
            gpsControls.classList.remove('hidden');
            tapControls.classList.add('hidden');
            map.off('click');
        });

        tapModeBtn.addEventListener('click', () => {
            currentMode = 'tap';
            tapModeBtn.classList.remove('bg-transparent', 'text-gray-700', 'dark:text-gray-300');
            tapModeBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg');
            gpsModeBtn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg');
            gpsModeBtn.classList.add('bg-transparent', 'text-gray-700', 'dark:text-gray-300');
            tapControls.classList.remove('hidden');
            gpsControls.classList.add('hidden');
            
            if (isTracking) {
                stopGPSTracking();
            }
            
            enableTapMode();
        });

        // GPS Tracking
        startGPSBtn.addEventListener('click', startGPSTracking);
        stopGPSBtn.addEventListener('click', stopGPSTracking);

        function startGPSTracking() {
            if (!navigator.geolocation) {
                showNotification('Geolocation is not supported by your browser', 'error');
                return;
            }

            isTracking = true;
            startGPSBtn.classList.add('hidden');
            stopGPSBtn.classList.remove('hidden');
            stopGPSBtn.style.display = 'flex';
            gpsStatus.classList.remove('hidden');

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    } else {
                        currentLocationMarker = L.circleMarker([lat, lng], {
                            radius: 8,
                            fillColor: '#3b82f6',
                            color: '#fff',
                            weight: 3,
                            fillOpacity: 0.9
                        }).addTo(map);
                    }

                    addBoundaryPoint(lat, lng);
                    accuracyDisplayEl.textContent = `±${Math.round(accuracy)}m`;
                    map.setView([lat, lng], 18);
                },
                (error) => {
                    console.error('GPS Error:', error);
                    showNotification('GPS error: ' + error.message, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }

        function stopGPSTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
            startGPSBtn.classList.remove('hidden');
            stopGPSBtn.classList.add('hidden');
            gpsStatus.classList.add('hidden');
        }

        // Tap Mode
        function enableTapMode() {
            map.on('click', (e) => {
                if (currentMode === 'tap') {
                    addBoundaryPoint(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        // Add boundary point
        function addBoundaryPoint(lat, lng) {
            boundaryPoints.push([lat, lng]);

            const marker = L.circleMarker([lat, lng], {
                radius: 7,
                fillColor: '#ef4444',
                color: '#fff',
                weight: 3,
                fillOpacity: 1,
                className: 'pulse-animate'
            }).addTo(map);
            
            marker.bindPopup(`
                <div class="text-center p-2">
                    <strong class="text-blue-600">Point ${boundaryPoints.length}</strong><br>
                    <span class="text-xs text-gray-600">Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}</span>
                </div>
            `);
            markers.push(marker);

            if (polyline) {
                map.removeLayer(polyline);
            }
            polyline = L.polyline(boundaryPoints, {
                color: '#3b82f6',
                weight: 3,
                opacity: 0.7
            }).addTo(map);

            updateStats();
        }

        // Undo last point
        undoPointBtn.addEventListener('click', () => {
            if (boundaryPoints.length > 0) {
                boundaryPoints.pop();
                const lastMarker = markers.pop();
                if (lastMarker) {
                    map.removeLayer(lastMarker);
                }
                
                if (polyline) {
                    map.removeLayer(polyline);
                }
                
                if (boundaryPoints.length > 0) {
                    polyline = L.polyline(boundaryPoints, {
                        color: '#3b82f6',
                        weight: 3,
                        opacity: 0.7
                    }).addTo(map);
                }
                
                updateStats();
                showNotification('Last point removed', 'success');
            }
        });

        // Clear map
        clearMapBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all points?')) {
                boundaryPoints = [];
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                
                if (polyline) {
                    map.removeLayer(polyline);
                    polyline = null;
                }
                if (polygon) {
                    map.removeLayer(polygon);
                    polygon = null;
                }
                
                updateStats();
                showNotification('Map cleared', 'success');
            }
        });

        // Complete polygon
        completePolygonBtn.addEventListener('click', () => {
            if (boundaryPoints.length < 3) {
                showNotification('Need at least 3 points to complete polygon', 'error');
                return;
            }

            if (polygon) {
                map.removeLayer(polygon);
            }

            polygon = L.polygon(boundaryPoints, {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.3,
                weight: 3
            }).addTo(map);

            map.fitBounds(polygon.getBounds());
            showNotification('Polygon completed!', 'success');
        });

        // Calculate area
        calculateAreaBtn.addEventListener('click', () => {
            if (boundaryPoints.length < 3) {
                showNotification('Need at least 3 points to calculate area', 'error');
                return;
            }

            const area = calculatePolygonArea(boundaryPoints);
            areaDisplayEl.textContent = `${area.toFixed(2)} m²`;
            
            const acres = (area * 0.000247105).toFixed(4);
            const hectares = (area * 0.0001).toFixed(4);
            
            showNotification(`Area: ${area.toFixed(2)} m² | ${acres} acres | ${hectares} ha`, 'success');
        });

        // Calculate polygon area using Shoelace formula
        function calculatePolygonArea(points) {
            if (points.length < 3) return 0;

            const R = 6371000; // Earth's radius in meters
            let area = 0;

            for (let i = 0; i < points.length; i++) {
                const p1 = points[i];
                const p2 = points[(i + 1) % points.length];
                
                const lat1 = p1[0] * Math.PI / 180;
                const lat2 = p2[0] * Math.PI / 180;
                const lng1 = p1[1] * Math.PI / 180;
                const lng2 = p2[1] * Math.PI / 180;
                
                area += (lng2 - lng1) * (2 + Math.sin(lat1) + Math.sin(lat2));
            }

            area = Math.abs(area * R * R / 2);
            return area;
        }

        // Update stats
        function updateStats() {
            pointCountEl.textContent = boundaryPoints.length;
            
            if (boundaryPoints.length >= 3) {
                const area = calculatePolygonArea(boundaryPoints);
                areaDisplayEl.textContent = `${area.toFixed(2)} m²`;
            } else {
                areaDisplayEl.textContent = '-- m²';
            }
        }

        // Location Permission Modal
        function showLocationPermissionModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center p-4';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            modal.innerHTML = `
                <div class="glass bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-md w-full border border-white/20 dark:border-gray-700/50">
                    <div class="flex flex-col items-center text-center">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Enable Location Access</h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">
                            Land Mapper needs your location to show satellite imagery of your area and track boundaries accurately.
                        </p>
                        <div class="flex flex-col gap-3 w-full">
                            <button id="allowLocation" class="w-full py-3 px-6 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200">
                                Allow Location Access
                            </button>
                            <button id="denyLocation" class="w-full py-2 px-6 rounded-xl bg-transparent text-gray-600 dark:text-gray-400 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-200">
                                Use Default Location
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('allowLocation').addEventListener('click', () => {
                modal.remove();
                requestUserLocation();
            });

            document.getElementById('denyLocation').addEventListener('click', () => {
                modal.remove();
                showNotification('Using default location. You can enable GPS tracking later.', 'info');
            });
        }

        // Request user location
        function requestUserLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation is not supported by your browser', 'error');
                return;
            }

            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'locationLoading';
            loadingIndicator.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[9998] glass bg-white/90 dark:bg-gray-800/90 rounded-2xl shadow-2xl p-6';
            loadingIndicator.innerHTML = `
                <div class="flex flex-col items-center gap-3">
                    <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-gray-700 dark:text-gray-300 font-semibold">Getting your location...</p>
                </div>
            `;
            document.body.appendChild(loadingIndicator);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // Center map on user location with high zoom
                    map.setView([lat, lng], 18);

                    // Add user location marker
                    const locationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `
                                <div style="position: relative;">
                                    <div style="width: 20px; height: 20px; background: #3b82f6; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: ${accuracy}px; height: ${accuracy}px; background: rgba(59, 130, 246, 0.2); border: 2px solid rgba(59, 130, 246, 0.5); border-radius: 50%;"></div>
                                </div>
                            `,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);

                    locationMarker.bindPopup(`
                        <div class="text-center p-2">
                            <strong class="text-blue-600">Your Location</strong><br>
                            <span class="text-xs text-gray-600">
                                Lat: ${lat.toFixed(6)}<br>
                                Lng: ${lng.toFixed(6)}<br>
                                Accuracy: ±${Math.round(accuracy)}m
                            </span>
                        </div>
                    `).openPopup();

                    loadingIndicator.remove();
                    showNotification(`Location found! Accuracy: ±${Math.round(accuracy)}m`, 'success');

                    // Store current location marker reference
                    window.userLocationMarker = locationMarker;
                },
                (error) => {
                    loadingIndicator.remove();
                    console.error('Location Error:', error);
                    
                    let errorMessage = 'Unable to get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Location permission denied. Please enable it in your browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'An unknown error occurred.';
                    }
                    
                    showNotification(errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Show location permission modal on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                showLocationPermissionModal();
            }, 1000);
        });

        // Add a button to re-center on user location
        const recenterBtn = L.control({ position: 'bottomright' });
        recenterBtn.onAdd = function() {
            const btn = L.DomUtil.create('button', 'glass bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-3 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200');
            btn.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            `;
            btn.title = 'Center on my location';
            btn.onclick = function(e) {
                e.stopPropagation();
                requestUserLocation();
            };
            return btn;
        };
        recenterBtn.addTo(map);
    </script>
</body>
</html>